<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Selector - AI Powered</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Markdown Parser (For Gemini Output) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: '#2563EB',
                        secondary: '#1E40AF',
                        accent: '#F59E0B',
                        dark: '#0F172A',
                        light: '#F8FAFC',
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px) scale(0.95)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .option-card { transition: all 0.2s ease; }
        .option-card:hover { border-color: #2563EB; background-color: #EFF6FF; transform: translateX(5px); }
        .option-selected { border-color: #2563EB; background-color: #DBEAFE; font-weight: bold; }
        
        /* Gemini Markdown Styles */
        .markdown-body h1, .markdown-body h2 { color: #0F172A; font-weight: 800; margin-bottom: 1rem; }
        .markdown-body h3 { color: #2563EB; font-weight: 700; margin-top: 1rem; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .markdown-body p { margin-bottom: 0.8rem; line-height: 1.6; }
        .markdown-body strong { color: #1E40AF; }

        /* Chatbot Styles */
        .chat-message { max-width: 85%; margin-bottom: 1rem; padding: 0.75rem; border-radius: 1rem; font-size: 0.9rem; line-height: 1.5; }
        .chat-user { background-color: #2563EB; color: white; margin-left: auto; border-bottom-right-radius: 0.25rem; }
        .chat-ai { background-color: #F1F5F9; color: #334155; margin-right: auto; border-bottom-left-radius: 0.25rem; border: 1px solid #E2E8F0; }
        .typing-dot { width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-light text-slate-700 font-sans antialiased flex flex-col min-h-screen">

    <!-- NAVIGATION -->
    <nav class="fixed w-full z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-slate-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center gap-2">
                    <a href="index.html" class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold">
                            <i class="fa-solid fa-graduation-cap"></i>
                        </div>
                        <span class="font-bold text-xl text-dark tracking-tight">Career <span class="text-primary">Bridge</span></span>
                    </a>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex space-x-6 items-center">
                    <a href="index.html" class="text-slate-600 hover:text-primary font-medium transition">Home</a>
                    <a href="roadmaps.html" class="text-slate-600 hover:text-primary font-medium transition">Roadmaps</a>
                    <a href="selection.html" class="text-primary font-bold transition">Career Selection</a>
                    <a href="#" class="text-slate-600 hover:text-primary font-medium transition">Goal Tracker</a>
                    <a href="#" class="text-slate-600 hover:text-primary font-medium transition">1 on 1 Meetings</a>
                </div>

                <!-- Auth Buttons -->
                <div class="hidden md:flex items-center space-x-4" id="auth-buttons">
                    <a href="login.html" class="bg-primary hover:bg-secondary text-white px-5 py-2 rounded-full font-medium transition shadow-lg shadow-primary/30">Log In</a>
                </div>
                
                <!-- Mobile Menu Button -->
                <div class="md:hidden flex items-center">
                    <button id="mobile-menu-btn" class="text-slate-600"><i class="fa-solid fa-bars text-2xl"></i></button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-white border-t border-slate-100">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium text-slate-700 hover:text-primary hover:bg-slate-50">Home</a>
                <a href="roadmaps.html" class="block px-3 py-2 rounded-md text-base font-medium text-slate-700 hover:text-primary hover:bg-slate-50">Roadmaps</a>
                <a href="selection.html" class="block px-3 py-2 rounded-md text-base font-medium text-primary font-bold bg-slate-50">Career Selection</a>
                <a href="#" class="block px-3 py-2 rounded-md text-base font-medium text-slate-700 hover:text-primary hover:bg-slate-50">Goal Tracker</a>
                <a href="#" class="block px-3 py-2 rounded-md text-base font-medium text-slate-700 hover:text-primary hover:bg-slate-50">1 on 1 Meetings</a>
                <a href="login.html" id="mobile-login-link" class="block px-3 py-2 rounded-md text-base font-medium text-primary font-bold">Log In</a>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-grow pt-24 pb-12 px-4 relative">
        
        <!-- Header -->
        <div class="max-w-3xl mx-auto text-center mb-10">
            <div class="inline-flex items-center gap-2 bg-blue-100 text-primary px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-4">
                <i class="fa-solid fa-wand-magic-sparkles"></i> AI Powered
            </div>
            <h1 class="text-3xl md:text-5xl font-extrabold text-dark mb-4">Discover Your Ideal Path</h1>
            <p class="text-slate-500 text-lg">Answer a few critical questions, and let our Gemini AI analyze your personality to suggest the perfect tech career for the Pakistani market.</p>
        </div>

        <!-- QUIZ CONTAINER -->
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl border border-slate-100 overflow-hidden relative min-h-[400px]">
            
            <!-- Progress Bar -->
            <div class="h-1 w-full bg-slate-100">
                <div id="progress-bar" class="h-full bg-primary transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>

            <!-- SCENE 1: START -->
            <div id="scene-start" class="p-8 md:p-12 text-center flex flex-col items-center justify-center h-full animate-fade-in-up">
                <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center text-4xl text-primary mb-6 animate-pulse-slow">
                    <i class="fa-solid fa-fingerprint"></i>
                </div>
                <h2 class="text-2xl font-bold text-dark mb-3">Ready to find your future?</h2>
                <p class="text-slate-500 mb-8">This takes less than 2 minutes. Be honest with your answers!</p>
                <button onclick="startQuiz()" class="bg-primary hover:bg-secondary text-white px-8 py-3 rounded-lg font-bold shadow-lg shadow-blue-500/30 transition transform hover:-translate-y-1">
                    Start Analysis
                </button>
            </div>

            <!-- SCENE 2: QUESTIONS (Dynamic) -->
            <div id="scene-question" class="hidden p-8 md:p-12 h-full flex flex-col">
                <span id="q-number" class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Question 1/5</span>
                <h3 id="q-text" class="text-2xl font-bold text-dark mb-8">Question text goes here?</h3>
                
                <div id="q-options" class="space-y-3 flex-grow">
                    <!-- Options injected via JS -->
                </div>

                <div class="mt-8 flex justify-between items-center">
                    <button onclick="prevQuestion()" id="btn-prev" class="text-slate-400 hover:text-dark font-medium text-sm hidden">
                        <i class="fa-solid fa-arrow-left mr-1"></i> Back
                    </button>
                    <button onclick="nextQuestion()" id="btn-next" class="bg-dark hover:bg-slate-800 text-white px-6 py-2 rounded-lg font-bold text-sm transition ml-auto disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Next <i class="fa-solid fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>

            <!-- SCENE 3: LOADING (AI Thinking) -->
            <div id="scene-loading" class="hidden p-8 md:p-12 text-center flex flex-col items-center justify-center h-full">
                <div class="relative w-24 h-24 mb-6">
                    <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-primary rounded-full border-t-transparent animate-spin"></div>
                    <i class="fa-solid fa-brain absolute inset-0 flex items-center justify-center text-3xl text-primary animate-pulse"></i>
                </div>
                <h2 class="text-xl font-bold text-dark mb-2">Analyzing your profile...</h2>
                <p class="text-slate-500 text-sm" id="loading-text">Connecting to Gemini AI...</p>
            </div>

            <!-- SCENE 4: RESULT -->
            <div id="scene-result" class="hidden p-8 md:p-12 overflow-y-auto max-h-[600px]">
                <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-lg flex items-center justify-center text-xl">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-dark">Your Ideal Career Path</h2>
                        <p class="text-xs text-slate-500 uppercase tracking-wider">AI Recommendation</p>
                    </div>
                </div>
                
                <!-- Gemini Output Goes Here -->
                <div id="result-content" class="markdown-body text-slate-600 text-sm md:text-base"></div>

                <!-- CTA for Non-Registered Users -->
                <div id="result-cta" class="mt-8 bg-blue-50 border border-blue-100 rounded-xl p-6 text-center hidden">
                    <div class="w-12 h-12 bg-white rounded-full shadow-md flex items-center justify-center mx-auto mb-3 text-primary text-xl">
                        <i class="fa-solid fa-comments"></i>
                    </div>
                    <h4 class="font-bold text-dark mb-2">Have questions about this result?</h4>
                    <p class="text-sm text-slate-600 mb-4">Unlock our <strong>AI Career Chatbot</strong> to ask follow-up questions, get interview tips, and personalized advice. Login required.</p>
                    <a href="login.html" class="inline-block bg-primary text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md hover:bg-secondary transition">Log in to Chat</a>
                </div>

                <div class="mt-8 text-center">
                    <button onclick="location.reload()" class="text-slate-400 hover:text-dark text-sm font-medium">
                        <i class="fa-solid fa-rotate-right mr-1"></i> Retake Quiz
                    </button>
                </div>
            </div>

        </div>
    </main>

    <!-- CHATBOT (Floating Action Button) - Registered Only -->
    <div id="chatbot-container" class="fixed bottom-6 right-6 z-50 hidden flex flex-col items-end gap-2">
        
        <!-- Helper Tooltip -->
        <div class="bg-white px-4 py-2 rounded-lg shadow-lg border border-slate-100 text-xs font-bold text-slate-600 mb-1 animate-bounce origin-bottom-right">
            Need advice? Chat with me! ðŸ‘‡
        </div>

        <!-- Chat Window -->
        <div id="chat-window" class="hidden bg-white w-80 sm:w-96 h-[500px] rounded-2xl shadow-2xl border border-slate-200 flex flex-col overflow-hidden animate-slide-up mb-2">
            <!-- Header -->
            <div class="bg-dark p-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center text-white text-xs">
                        <i class="fa-solid fa-robot"></i>
                    </div>
                    <div>
                        <h4 class="text-white font-bold text-sm">Career Coach</h4>
                        <p class="text-xs text-slate-400 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Online</p>
                    </div>
                </div>
                <button onclick="toggleChat()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <!-- Messages Area -->
            <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 bg-slate-50">
                <!-- Welcome Message -->
                <div class="chat-message chat-ai">
                    Hello! I've analyzed your quiz results. Ask me anything about your recommended career path!
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-white border-t border-slate-100">
                <form onsubmit="handleChatSubmit(event)" class="flex gap-2">
                    <input type="text" id="chat-input" class="flex-grow border border-slate-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-primary" placeholder="Ask about salaries, skills..." required>
                    <button type="submit" class="bg-primary hover:bg-secondary text-white w-10 h-10 rounded-lg flex items-center justify-center transition">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Floating Button (Highlighted & Text Added) -->
        <button id="chat-fab" onclick="toggleChat()" class="group flex items-center gap-3 bg-primary hover:bg-secondary text-white pl-5 pr-2 py-2 rounded-full shadow-xl transition-all duration-300 hover:scale-105">
            <span class="font-bold text-sm tracking-wide">Ask AI Coach</span>
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center text-lg">
                <i class="fa-solid fa-comments"></i>
            </div>
        </button>
    </div>

    <!-- FOOTER -->
    <footer class="bg-dark text-slate-400 py-12 border-t border-slate-800 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div class="col-span-1 md:col-span-2">
                    <div class="flex items-center gap-2 mb-4 text-white">
                        <i class="fa-solid fa-graduation-cap text-primary text-2xl"></i>
                        <span class="font-bold text-xl">Career Bridge</span>
                    </div>
                    <p class="text-sm leading-relaxed max-w-xs">
                        Empowering the next generation of Pakistani professionals with guidance, community, and opportunity.
                    </p>
                </div>
                <div>
                    <h4 class="text-white font-bold mb-4">Quick Links</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="hover:text-primary transition">About Us</a></li>
                        <li><a href="#" class="hover:text-primary transition">Events</a></li>
                        <li><a href="#" class="hover:text-primary transition">Blog</a></li>
                        <li><a href="#" class="hover:text-primary transition">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-white font-bold mb-4">Connect</h4>
                    <div class="flex space-x-4">
                        <a href="https://www.facebook.com" target="_blank" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-primary hover:text-white transition">
                            <i class="fa-brands fa-facebook-f"></i>
                        </a>
                        <a href="https://www.linkedin.com" target="_blank" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-primary hover:text-white transition">
                            <i class="fa-brands fa-linkedin-in"></i>
                        </a>
                        <a href="https://twitter.com" target="_blank" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-primary hover:text-white transition">
                            <i class="fa-brands fa-twitter"></i>
                        </a>
                        <a href="https://www.instagram.com" target="_blank" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-primary hover:text-white transition">
                            <i class="fa-brands fa-instagram"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-slate-800 pt-8 text-center text-xs">
                <p>&copy; 2025 Career Bridge Pakistan. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const supabaseUrl = 'https://sbytszsxhkzehqrxgjrl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNieXRzenN4aGt6ZWhxcnhnanJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTkwNTUsImV4cCI6MjA3OTIzNTA1NX0.Nm6Ig-M7eYtPB30O9jicqIg48Wont4uY4Kz2_3ibZ0c';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // KEY
        const GEMINI_API_KEY = 'AIzaSyAC7fznwr4XQ3MjZR-2TmQG_wajb4sa9Fo'; 

        // --- STATE ---
        let isLoggedIn = false;
        let currentQuestion = 0;
        let userAnswers = [];
        let chatHistory = []; // For context

        // --- CRITICAL QUESTIONS ---
        const questions = [
            {
                text: "What excites you the most when looking at a new app?",
                options: [
                    "How beautiful and smooth the design looks.",
                    "How the features actually work behind the scenes.",
                    "How the data is stored and processed securely.",
                    "How to market it and get more users."
                ]
            },
            {
                text: "When you face a complex problem, what is your first instinct?",
                options: [
                    "Draw a diagram or visualize the solution.",
                    "Break it down into small logical steps/code.",
                    "Look for patterns in data or past examples.",
                    "Talk to people to understand the root cause."
                ]
            },
            {
                text: "If you could build anything right now, what would it be?",
                options: [
                    "A visually stunning portfolio or game.",
                    "A smart automation tool or trading bot.",
                    "A secure banking system or firewall.",
                    "A mobile app that solves a daily social problem."
                ]
            },
            {
                text: "Which work environment sounds best to you?",
                options: [
                    "Creative studio with designers and artists.",
                    "Quiet room with multiple monitors and code.",
                    "Server room or command center monitoring traffic.",
                    "Fast-paced startup brainstorming with a team."
                ]
            },
            {
                text: "What do you value most in a career?",
                options: [
                    "Creativity and Visual Impact.",
                    "Logic, Structure and Efficiency.",
                    "Security, Stability and Protection.",
                    "Innovation and User Interaction."
                ]
            }
        ];

        // --- AUTH CHECK ---
        async function checkUser() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                isLoggedIn = true;
                document.getElementById('auth-buttons').innerHTML = `<button onclick="handleLogout()" class="bg-slate-200 hover:bg-slate-300 text-slate-800 px-5 py-2 rounded-full font-medium">Sign Out</button>`;
                document.getElementById('mobile-login-link').style.display = 'none';
                
                // SHOW CHATBOT FOR REGISTERED USERS
                document.getElementById('chatbot-container').classList.remove('hidden');
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            window.location.reload();
        }

        // --- QUIZ LOGIC ---
        function startQuiz() {
            document.getElementById('scene-start').classList.add('hidden');
            document.getElementById('scene-question').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            const q = questions[currentQuestion];
            document.getElementById('q-number').innerText = `QUESTION ${currentQuestion + 1}/${questions.length}`;
            document.getElementById('q-text').innerText = q.text;
            document.getElementById('progress-bar').style.width = `${((currentQuestion) / questions.length) * 100}%`;
            
            const optionsContainer = document.getElementById('q-options');
            optionsContainer.innerHTML = '';

            q.options.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = `option-card border-2 border-slate-100 rounded-xl p-4 cursor-pointer flex items-center gap-3 text-slate-600 font-medium`;
                btn.onclick = () => selectOption(idx, btn);
                btn.innerHTML = `
                    <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center text-xs text-white ${userAnswers[currentQuestion] === idx ? 'bg-primary border-primary' : ''}">
                        ${userAnswers[currentQuestion] === idx ? '<i class="fa-solid fa-check"></i>' : ''}
                    </div>
                    ${opt}
                `;
                if (userAnswers[currentQuestion] === idx) {
                    btn.classList.add('option-selected');
                }
                optionsContainer.appendChild(btn);
            });

            document.getElementById('btn-prev').classList.toggle('hidden', currentQuestion === 0);
            document.getElementById('btn-next').innerText = currentQuestion === questions.length - 1 ? "Finish & Analyze" : "Next";
            document.getElementById('btn-next').disabled = userAnswers[currentQuestion] === undefined;
        }

        function selectOption(idx, element) {
            userAnswers[currentQuestion] = idx;
            renderQuestion();
        }

        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                renderQuestion();
            } else {
                finishQuiz();
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                renderQuestion();
            }
        }

        // --- GEMINI QUIZ INTEGRATION ---
        async function finishQuiz() {
            if (!GEMINI_API_KEY) {
                alert("Please add your Gemini API Key in the code!");
                return;
            }

            document.getElementById('scene-question').classList.add('hidden');
            document.getElementById('scene-loading').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '100%';

            const answerText = questions.map((q, i) => `Q: ${q.text} A: ${q.options[userAnswers[i]]}`).join('\n');
            
            let systemInstruction = isLoggedIn 
                ? `You are an expert Career Counselor for the Pakistani Tech Industry. Analyze the user's answers and recommend ONE ideal tech career. Provide a detailed Markdown response with: The Role Name, Why it fits (briefly), Average Salary in Pakistan (PKR), Key Skills, Top 3 Pakistan Companies.`
                : `You are an expert Career Counselor. Analyze the user's answers and recommend ONE ideal tech career. Provide a SHORT, teaser Markdown response (max 3 sentences). Name the role, briefly why, and end by saying: "Unlock full details and Chat with AI Coach by creating a free account."`;

            const prompt = `${systemInstruction}\n\nUser Answers:\n${answerText}`;

            try {
                // Using gemini-2.5-flash (Working Model)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error?.message || "Unknown API Error");
                }

                const aiText = data.candidates[0].content.parts[0].text;

                document.getElementById('scene-loading').classList.add('hidden');
                document.getElementById('scene-result').classList.remove('hidden');
                
                document.getElementById('result-content').innerHTML = marked.parse(aiText);

                if (!isLoggedIn) {
                    document.getElementById('result-cta').classList.remove('hidden');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                const loadingText = document.getElementById('loading-text');
                loadingText.innerHTML = `<strong>Connection Failed:</strong><br>${error.message}<br><button onclick="location.reload()" class="underline mt-2">Try Again</button>`;
                loadingText.classList.add('text-red-500');
            }
        }

        // --- CHATBOT LOGIC ---
        function toggleChat() {
            const window = document.getElementById('chat-window');
            window.classList.toggle('hidden');
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // 1. Add User Message
            appendMessage(message, 'user');
            input.value = '';

            // 2. Add Loading Bubble
            const loadingId = appendLoading();

            // 3. Contextual Prompt
            const systemPrompt = "You are a helpful, encouraging Career Coach for Pakistani students. Keep answers concise (max 3 sentences). Focus on local market trends.";
            const context = chatHistory.map(msg => `User: ${msg.user}\nAI: ${msg.ai}`).join('\n');
            const fullPrompt = `${systemPrompt}\n\nPrevious Chat:\n${context}\n\nCurrent Question: ${message}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                });

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;

                // Remove Loading, Add AI Message
                document.getElementById(loadingId).remove();
                appendMessage(aiResponse, 'ai');

                // Save to History (Limit to last 5 turns)
                chatHistory.push({ user: message, ai: aiResponse });
                if (chatHistory.length > 5) chatHistory.shift();

            } catch (error) {
                document.getElementById(loadingId).remove();
                appendMessage("Sorry, I'm having trouble connecting right now.", 'ai');
            }
        }

        function appendMessage(text, sender) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `chat-message ${sender === 'user' ? 'chat-user' : 'chat-ai'}`;
            // Simple markdown support for chat
            div.innerHTML = sender === 'ai' ? marked.parse(text) : text; 
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function appendLoading() {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const id = 'loading-' + Date.now();
            div.id = id;
            div.className = `chat-message chat-ai flex gap-1 items-center`;
            div.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        const btn = document.getElementById('mobile-menu-btn');
        const menu = document.getElementById('mobile-menu');
        if(btn && menu) {
            btn.addEventListener('click', () => menu.classList.toggle('hidden'));
        }

        document.addEventListener('DOMContentLoaded', checkUser);
    </script>
</body>

</html>
